# テストガイド

このドキュメントでは、プロジェクトのテストの実行方法について説明します。

## テストの実行

プロジェクトのルートディレクトリで以下のコマンドを実行すると、Dubがテストをビルドし、実行します。
`Makefile`は、必須コンパイラであるLDC (`ldc2`) を使ってテストをビルドするように設定されています。

```bash
make test
```

### テスト構成に関する知見

ユニットテストの構成において、以下の点に留意する必要があります。

1.  **`dub.json`の`unittest`構成**:
    *   `targetType`は`"executable"`に設定する必要があります。これにより、D言語のランタイムが初期化され、GCが正しく動作します。
    *   `sourcePaths`はテスト対象のモジュールを正確に指定し、`main`関数を含む可能性のあるファイル（例: `tests/poc/dummy.d`や`source/plugin/dllmain.d`）は`excludedSourceFiles`で明示的に除外する必要があります。
    *   `mainSourceFile`を明示的に指定することで、`dub`がテストランナーの`main`関数を正しく生成できるようになります。例えば、`tests/test_runner_main.d`のようなシンプルな`void main() {}`を持つファイルを作成し、それを指定します。

2.  **`struct` `ScopedPatch`のライフサイクルとメモリ管理**:
    *   `ScopedPatch`は値型 (`struct`) であり、スコープを抜けた瞬間にデストラクタが確定的に呼び出されます。これにより、RAIIパターンを用いてメモリパッチの適用と復元が予測可能なタイミングで行われます。
    *   `mmap`で確保したGC管理外のメモリを操作する際には、GC管理下のオブジェクト（例: `dup`でコピーされた`ubyte[]`）が`mmap`で確保したメモリを参照して`InvalidMemoryOperationError`が発生するのを防ぐため、`ScopedPatch`内でバックアップデータに動的配列`ubyte[]`を使用しつつも、`ScopedPatch`自体を`struct`とすることでGCのライフサイクルに安全に連携するように設計されています。

3.  **W^X（Write XOR Execute）の原則**:
    *   現代のLinuxカーネルやセキュリティ設定では、メモリページに書き込み（W）と実行（X）の権限を同時に付与することを禁止している場合があります。
    *   メモリに実行コードを書き込む際には、`mprotect`を2回使用し、まず`PROT_READ | PROT_WRITE`で書き込み可能にしてデータを書き込み、その後`PROT_READ | PROT_EXEC`で実行可能に戻すという手順を踏む必要があります。
4. **ロギングの変更**:
    *   テスト実行時のログ出力は、`dlogg`からD言語標準の`std.logger`に移行されました。これにより、統一されたロギングフレームワークが利用され、ログレベル（`LogLevel.info`, `LogLevel.error`など）による詳細な制御が可能になりました。

### テスト結果

上記コマンド実行後、成功メッセージが表示されれば、テストは成功です。
