# テストガイド

このドキュメントでは、プロジェクトのテストの実行方法について説明します。

## テストの実行

プロジェクトのルートディレクトリで以下のコマンドを実行すると、Dubがテストをビルドし、実行します。

```bash
make test
```

### テスト構成に関する知見

ユニットテストの構成において、以下の点に留意する必要があります。

1.  **`dub.json`の`unittest`構成**:
    *   `targetType`は`"executable"`に設定する必要があります。これにより、D言語のランタイムが初期化され、GCが正しく動作します。
    *   `sourcePaths`はテスト対象のモジュールを正確に指定し、`main`関数を含む可能性のあるファイル（例: `tests/poc/dummy.d`や`source/plugin/dllmain.d`）は`excludedSourceFiles`で明示的に除外する必要があります。
    *   `mainSourceFile`を明示的に指定することで、`dub`がテストランナーの`main`関数を正しく生成できるようになります。例えば、`tests/test_runner_main.d`のようなシンプルな`void main() {}`を持つファイルを作成し、それを指定します。
    *   `silly`のような外部テストランナーを使用する場合、そのドキュメントと`dub`の挙動に矛盾が生じることがあります。その際は、D言語の標準的なテスト機能を利用するアプローチを検討し、問題の切り分けを行うことが重要です。

2.  **`class`と`struct`のライフサイクル**:
    *   D言語の`class`はGCによって管理される参照型であり、デストラクタ（ファイナライザ）が呼び出されるタイミングは不定です。ファイナライザ内でのGC管理下のメモリアロケーションやオブジェクトへのアクセスは禁止されています。
    *   `struct`は値型であり、スコープを抜けた瞬間にデストラクタが確定的に呼び出されます。RAIIパターンを実装する際には`struct`を使用することが推奨されます。

3.  **GCと`mmap`のメモリ管理の衝突**:
    *   `mmap`で確保したメモリはGC管理外です。GC管理下のオブジェクト（例: `dup`でコピーされた`ubyte[]`）が`mmap`で確保したメモリを参照していると、GCが不正なメモリオペレーションを検出して`InvalidMemoryOperationError`が発生する可能性があります。
    *   GC管理外のメモリを操作する際には、`malloc`/`free`などのC標準ライブラリの関数を使用してメモリを管理し、GCとの衝突を避ける必要があります。

4.  **W^X（Write XOR Execute）の原則**:
    *   現代のLinuxカーネルやセキュリティ設定では、メモリページに書き込み（W）と実行（X）の権限を同時に付与することを禁止している場合があります。
    *   メモリに実行コードを書き込む際には、`mprotect`を2回使用し、まず`PROT_READ | PROT_WRITE`で書き込み可能にしてデータを書き込み、その後`PROT_READ | PROT_EXEC`で実行可能に戻すという手順を踏む必要があります。

### テスト結果

上記コマンド実行後、成功メッセージが表示されれば、テストは成功です。

