# D言語移行 TODOリスト

## 優先度: 高

-   [x] `Plugin64/` ディレクトリ内の残りのC++ファイルをD言語に移植する。
    -   **入力・IME関連モジュール**
        -   `input.cpp` / `input_asm.asm`: テキスト入力フック、UTF-8変換。
        -   `ime.cpp` / `ime_asm.asm`: IME制御、再変換対応など。
    -   **フォント・テキスト描画・整形モジュール**
        -   `font.cpp` / `font_asm.asm`: フォントバッファ管理、サイズ拡張。
        -   `main_text.cpp` / `main_text_asm.asm`: メインテキスト描画フック。
        -   `list_field_adjustment.cpp` / `list_field_adjustment_asm.asm`: リストビューの文字調整。
        -   `date.cpp` / `date_asm.asm`: 日付フォーマット修正。
        -   `localization.cpp` / `localization_asm.asm`: ローカライズ関連（人名順序など）。
    -   **マップ・UI表示調整モジュール**
        -   `map_view.cpp` / `map_view_asm.asm`: マップ上のテキスト表示。
        -   `map_adjustment.cpp` / `map_adjustment_asm.asm`: マップ文字位置調整。
        -   `map_justify.cpp` / `map_justify_asm.asm`: マップ文字均等割付。
        -   [x] `map_popup.cpp` / `map_popup_asm.asm`: ポップアップ表示調整。
        -   [x] `tooltip_and_button.cpp` / `tooltip_and_button_asm.asm`: ツールチップとボタンのUI調整。
        -   [x] `event_dialog.cpp` / `event_dialog_asm.asm`: イベントダイアログ修正。
    -   **システム・その他機能モジュール**
        -   [x] `file_save.cpp` / `file_save_asm.asm`: セーブデータ関連。
        -   [x] `options.cpp`: 設定ファイル (`plugin.ini`) 読み込み。
        -   [x] `dll_main.cpp`, `version.cpp`: DLLエントリーポイント、バージョン管理。
-   [x] Linux環境でのパッチ適用方法を `LD_PRELOAD` を利用した手法に移行する。
    -   [x] `d3d9.dll` プロキシの代わりに、共有オブジェクト（`.so`）を `LD_PRELOAD` でロードする仕組みを実装する。
    -   [x] Windows API (`VirtualProtect` など) に依存しているコードをLinux API (`mprotect(2)`, `dl_iterate_phdr(3)` など) を使用するように書き換える。
    -   [x] パッチ実行の起点として `__attribute__((constructor))` を利用する。
    -   [x] `version/` プロジェクトの機能（DLLインジェクションの起点）を `LD_PRELOAD` 方式に適合させる。
    -   **計画**:
        -   [x] 既存の `plugin.input`, `plugin.ime` などの `init` 関数における `Injector::MakeJMP` 相当のダミー実装を、`plugin.patcher.patcher.ScopedPatch` を利用した実際のパッチ適用に置き換える。 (input.d は完了)
        -   [x] `plugin.byte_pattern.BytePattern` を使用して、Linux環境のELFバイナリから適切なアドレスを検索する。
        -   [x] `plugin.process.process.get_executable_memory_range` を活用し、必要に応じて実行可能ファイルのメモリ範囲を取得する。
        -   [x] `plugin.ime.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.font.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.main_text.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.list_field_adjustment.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.date.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.localization.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.map_view.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.map_adjustment.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.map_justify.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.map_popup.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.tooltip_and_button.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.event_dialog.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.file_save.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.options.d` のダミー実装を `ScopedPatch` に置き換える。
        -   [x] `plugin.plugin_version.d` のダミー実装を `ScopedPatch` に置き換える。
-   [x] Linux環境での動作検証とデバッグ。
    -   [x] `mprotect(2)` を利用したメモリパッチの安定性確認。
    -   [x] `make all` コマンドでプロジェクトをビルドし、エラーがないことを確認する。
    -   [x] `make test` コマンドでテストを実行し、PASSすることを確認する。
    -   [ ] `LD_PRELOAD` を使用してパッチが正しく適用され、ゲームが動作することを確認する。
    -   [ ] 各機能が期待通りに動作することを確認する。
-   [ ] **翻訳ファイルダウンローダーのPoC作成**
    -   [ ] `tests/poc/downloader.d` の作成。
    -   [ ] `std.net.curl` を使用したファイルのダウンロード機能の実装。
    -   [ ] OSごとの適切な保存先パス（Linux: `~/.local/share/...`, Windows: `Documents/...`）の解決ロジック実装。
    -   [ ] 既存の `mod_download.cpp` / `claes.exe` 依存からの脱却準備。
-   [ ] `Plugin64/` のC++ファイルをD言語に移植する。
    -   [ ] `map_nudge_view.cpp` / `map_nudge_view_asm.asm` (マップナッジビュー関連のフック) を `plugin.map_nudge_view.d` に移植する。
    -   [ ] `escape_tool.cpp` / `escape_tool.h` (文字コード変換、Paradoxテキストオブジェクト処理) を `plugin.escape_tool.d` に移植する。
    -   [ ] `validator.cpp` (バージョンチェック、エラー表示) を `plugin.validator.d` に移植する（Linux環境向けにログ/コンソール出力で代替）。
    -   [ ] `debug.cpp` / `debug_asm.asm` (デバッグ用フック) を `plugin.debug.d` に移植する。
        -   **備考**: `program.cpp` と `mod_download.cpp` は、`mod_download` は既存タスクがあるため、`program.cpp` は空なので除外。

## 優先度: 中

-   [ ] 移植されたD言語コードのパフォーマンス最適化。
-   [ ] D言語のユニットテストカバレッジの拡充。
-   [ ] CI/CDパイプラインのD言語ビルドプロセスへの適応。

## 優先度: 低

-   [ ] ドキュメントのD言語移行に関する詳細な記述の追加。
-   [ ] D言語のコーディング規約の策定と適用。
