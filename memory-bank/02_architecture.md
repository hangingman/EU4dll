# アーキテクチャ

このプロジェクトは、主にC++で記述された複数のDLLプロジェクトで構成されていましたが、D言語への移行を進めています。将来的には、D言語への完全移行とLinux環境での動作を目指しています。

## 主要コンポーネント

-   **Plugin/**: EU4の32bit版に対応するメインのプラグインプロジェクトです。文字描画や入力処理など、ゲームの様々な機能にフックをかけて改造します。
-   **Plugin64/**: EU4の64bit版に対応するメインのプラグインプロジェクトです。`Plugin/` と同様の機能を持ちますが、64bitアーキテクチャ用にビルドされます。
-   **d3d9/**: Direct3D 9 のプロキシDLLとして動作し、ゲームの描画処理に介入します。主にフォントのレンダリングを担当します。
-   **version/**: `version.dll` のプロキシDLLとして動作し、DLLインジェクションの起点となります。
-   **source/**: D言語で書かれたソースコードが含まれています。これは将来的なD言語への移行を見据えたものです。
-   **resource/**: リリース用のDLLや設定ファイルが配置されます。
-   **memory-bank/**: AIアシスタントがプロジェクトを理解するためのドキュメントが格納されています。
-   **.clinerules**: AIアシスタントの動作を定義するルールファイルです。

## データフロー

1.  ゲーム（`eu4.exe`）が起動すると、WindowsのDLL読み込み機構により、プロキシDLLである `version.dll`（`version/` プロジェクト）が読み込まれます。
2.  `version.dll` は、`d3d9.dll`（`d3d9/` プロジェクト）と、メインのプラグインDLL（`Plugin.dll` または `Plugin64.dll`）をロードします。
3.  `d3d9.dll` は、ゲームのDirect3Dデバイスをフックし、テキスト描画処理を乗っ取ります。これにより、カスタムフォントの利用や2バイト文字の描画が可能になります。
4.  メインのプラグインDLLは、ゲーム内の様々な関数をフックし、UIの調整、入力処理の改善、その他の拡張機能を提供します。

## Linux環境でのパッチ適用に関する検討

Windows環境でDLLインジェクションとメモリフックによって実現されているゲームの改変は、Linux環境においても同様の手法で実現可能であることが調査により判明しました。具体的には、Windows APIの `VirtualProtect` に相当するLinuxの `mprotect(2)` を利用し、実行中のプロセスのメモリ領域の権限を動的に変更することで、機械語レベルでのパッチ適用を行います。

詳細については、[Linuxでのパッチ適用詳細](./details/linux_patching_details.md) を参照してください。

### メモリパッチ管理の設計判断 (`ScopedPatch`の`struct`化)

メモリパッチをRAIIパターンで安全に管理するため、`ScopedPatch`を`struct`として設計しました。この設計判断の理由は以下の通りです。

*   **確定的なデストラクタの呼び出し**: D言語の`struct`は値型であり、スコープを抜けた瞬間にデストラクタが確定的に呼び出されます。これにより、パッチの適用と復元が予測可能なタイミングで行われるようになり、メモリの状態管理が容易になります。
*   **GCとの競合回避**: `ScopedPatch`は`mmap`で確保したGC管理外のメモリを操作するため、`struct`化することでGCの介入を完全に排除し、`InvalidMemoryOperationError`のようなGC関連のエラーを回避します。また、元データのバックアップにはGC管理下の動的配列`ubyte[]`を使用していますが、`ScopedPatch`自体が値型であるため、その寿命は確定しており、GCとの連携が安全に行われます。
*   **W^X原則への対応**: `patch_memory`関数は、W^X（Write XOR Execute）の原則に準拠し、メモリページに書き込みと実行の権限を同時に付与しないように設計されています。これは、セキュリティ強化された環境でのメモリパッチ操作の安定性を保証するために重要です。

## D言語移行の進捗

-   `byte_pattern` モジュールはD言語への移植が完了し、対応するC++ファイル (`Plugin/byte_pattern.cpp`, `Plugin/byte_pattern.h`, `Plugin64/byte_pattern.cpp`, `Plugin64/byte_pattern.h`) は削除されました。
-   `patcher` モジュールはD言語で新規に実装されました。
-   ロギングライブラリが`dlogg`からD言語標準の`std.logger`に移行されました。
-   `BytePattern`クラスに`getFirst()`, `getSecond()`, `get(int index)`メソッドが追加されました。
-   `mod.d`におけるYAMLファイルのパス解決の問題が修正され、堅牢性が向上しました。
